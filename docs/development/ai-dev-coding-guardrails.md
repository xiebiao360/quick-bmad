# AI 代码规划与修改护栏（项目绑定，模板）

> 这是项目绑定文件模板。目的是提供短小、强约束的护栏，避免 agent 在规划与改码时走错路。

---

## 1. 使用规则（必须）

1. 在开始任何代码规划/修改前，先阅读本文件。
2. 若本文件与通用最佳实践冲突，以本文件为准（项目优先）。
3. 若存在例外，必须在任务文档中写明：例外条款、原因、风险、回滚方案。

---

## 2. 高优先级护栏（按需裁剪）

### 2.1 配置加载逻辑

- 说明你项目的配置加载顺序（例如 `default.toml` + `{RUN_MODE}.toml`）。
- 禁止在代码里硬编码环境差异。

### 2.2 数据库与 Redis

- 明确：开发/验证是否必须使用外部 DB/Redis。
- 禁止硬编码连接地址。

### 2.3 数据库迁移（sqlx-cli）

- 先阅读 `migrations/` 历史脚本。
- 创建迁移：`sqlx migrate add -r <migration_name>`
- 执行迁移时若无 `.env` 默认连接，要求显式 `-D "<database_url>"`。

### 2.4 SQLx 查询规范

- 是否避免 `sqlx::query!` / `query_as!` 宏（若要避免，请写明理由与替代模式）。

### 2.5 API 设计与网关

- 是否要求所有外部请求先到网关再分发。
- 路径规范（示例）：`/api/{service}/admin/*`、`/api/{service}/v1/*`。

### 2.6 项目结构定位

- `services/` / `clients/` / `libs/` / `migrations/` / `infra/` / `docs/` 的职责说明。

### 2.7 后端 DDD 分层

- Domain / Application / Infrastructure / Interface(API) 分层约束与依赖方向。

---

## 3. 最小清单

- 改前：已读护栏、已确认配置来源、已确认不扩大 scope。
- 提交前：迁移可执行（若有）、风险与回滚已记录。
